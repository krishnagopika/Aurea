name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 600s
          script: |
            set -euo pipefail

            # Install Docker using the universal convenience script (works on AL2/AL2023/Ubuntu/Debian)
            if ! command -v docker &>/dev/null; then
              echo "Installing Docker..."
              curl -fsSL https://get.docker.com | sudo sh
              sudo systemctl enable --now docker
              sudo usermod -aG docker ec2-user
            fi

            # Install Docker Compose V2 plugin if not present
            if ! sudo docker compose version &>/dev/null 2>&1; then
              echo "Installing Docker Compose V2 plugin..."
              sudo mkdir -p /usr/local/lib/docker/cli-plugins
              sudo curl -SL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64" \
                   -o /usr/local/lib/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
            fi

            # Install git and aws-cli if missing
            if ! command -v git &>/dev/null; then
              if command -v apt-get &>/dev/null; then
                sudo apt-get install -y git awscli
              elif command -v yum &>/dev/null; then
                sudo yum install -y git awscli
              elif command -v dnf &>/dev/null; then
                sudo dnf install -y git aws-cli
              fi
            fi

            echo "Docker: $(sudo docker --version)"
            echo "Compose: $(sudo docker compose version)"

            # Clone or pull latest code
            if [ -d /opt/aurea ]; then
              echo "Pulling latest code..."
              cd /opt/aurea && sudo git pull
            else
              echo "Cloning repo..."
              sudo git clone https://github.com/krishnagopika/Aurea.git /opt/aurea
            fi

            cd /opt/aurea

            # Fetch .env from S3 using EC2 IAM role
            aws s3 cp s3://aurea-config-hacklondon/backend.env /opt/aurea/backend/.env
            echo ".env fetched from S3"

            # Build and restart containers
            sudo docker compose down --remove-orphans || true
            sudo docker compose up -d --build

            echo "=== Deployed successfully ==="
            sudo docker compose ps
