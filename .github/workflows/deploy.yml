name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 600s
          script: |
            set -euo pipefail

            # Detect package manager (Amazon Linux 2=yum, AL2023=dnf, Ubuntu=apt-get)
            if command -v dnf &>/dev/null; then
              PKG="dnf"
            elif command -v yum &>/dev/null; then
              PKG="yum"
            elif command -v apt-get &>/dev/null; then
              PKG="apt-get"
            else
              echo "No supported package manager found"; exit 1
            fi
            echo "Package manager: $PKG"

            # Install Docker via native package manager (avoids get.docker.com which blocks amzn)
            if ! command -v docker &>/dev/null; then
              echo "Installing Docker..."
              sudo $PKG install -y docker git
              sudo systemctl enable --now docker
              sudo usermod -aG docker ec2-user
            fi

            # Install AWS CLI if missing
            if ! command -v aws &>/dev/null; then
              if [ "$PKG" = "apt-get" ]; then
                sudo apt-get install -y awscli
              else
                sudo $PKG install -y aws-cli awscli 2>/dev/null || true
              fi
            fi

            # Install Docker Compose V2 plugin (standalone binary â€” works on all distros)
            if ! sudo docker compose version &>/dev/null 2>&1; then
              echo "Installing Docker Compose V2..."
              sudo mkdir -p /usr/local/lib/docker/cli-plugins
              sudo curl -SL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-$(uname -m)" \
                   -o /usr/local/lib/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
            fi

            echo "Docker: $(sudo docker --version)"
            echo "Compose: $(sudo docker compose version)"

            # Clone or pull latest code
            if [ -d /opt/aurea ]; then
              echo "Pulling latest code..."
              sudo git -C /opt/aurea pull
            else
              echo "Cloning repo..."
              sudo git clone https://github.com/krishnagopika/Aurea.git /opt/aurea
            fi

            cd /opt/aurea

            # Fetch .env from S3 using EC2 IAM role
            # sudo -E preserves environment so IMDSv2 role credentials are passed through
            sudo -E aws s3 cp s3://aurea-config-hacklondon/backend.env /opt/aurea/backend/.env
            echo ".env fetched from S3"

            # Build and restart containers
            sudo docker compose down --remove-orphans || true
            sudo docker compose up -d --build

            echo "=== Deployed successfully ==="
            sudo docker compose ps
